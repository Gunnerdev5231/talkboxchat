<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Application with Account System</title>
    <style>
        /* Add your CSS here */
        .container {
            width: 100%;
            max-width: 320px;
            margin: auto;
        }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f7f7f7;
        }
        #chat {
            display: flex;
            flex-direction: column;
            height: 90vh;
            max-width: 600px;
            margin: auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            background: #fff;
        }
        #messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            background: #e5e5e5;
        }
        #input {
            display: flex;
            padding: 10px;
        }
        #input input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            margin-right: 10px;
        }
        #input button {
            padding: 10px;
            background-color: #333;
            color: white;
            border: none;
        }
        .message {
            padding: 10px;
            background: #fff;
            margin: 5px;
            border-radius: 5px;
        }
    </style>
</head>
<body>

<div class="container" id="auth-container">
    <!-- Authentication Section -->
    <h2>Login or Register</h2>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <button id="register-button">Register</button>
    <button id="login-button">Login</button>
    <button onclick="logout()" style="display:none;">Logout</button>
</div>

<div id="chat">
    <div id="messages"></div>
    <div id="input">
        <input type="text" id="messageBox" placeholder="Type your message...">
        <button onclick="publishMessage()">Send</button>
    </div>
</div>

<script type="module">
     // Import the functions you need from the SDKs you need
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-auth.js";
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries
  const auth = getAuth(app);
  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyA1q2CABQm0DWVAMp_yCyiizt0tvIjHbAc",
    authDomain: "talkboxchat-20646.firebaseapp.com",
    projectId: "talkboxchat-20646",
    storageBucket: "talkboxchat-20646.appspot.com",
    messagingSenderId: "955786253919",
    appId: "1:955786253919:web:de275445450e7092b9edea",
    measurementId: "G-5TZC4YEY69"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);

    // Initialize Firebase
    document.addEventListener('DOMContentLoaded', function() {
        const auth = firebase.auth();
        
        function register() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            createUserWithEmailAndPassword(auth, email, password){
                .then((userCredential) => {
                    // Registered
                    var user = userCredential.user;
                    console.log('User created:', user);
                })
                .catch((error) => {
                    // Handle Errors here.
                    var errorCode = error.code;
                    var errorMessage = error.message;
                    console.error('Error creating user:', errorCode, errorMessage);
                    // You can display the error message to the user here.
                });
        }

        function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Logged in
                    const user = userCredential.user;
                    console.log('Logged in', user);
                    document.getElementById('chat').style.display = 'block';
                    document.getElementById('auth-container').style.display = 'none';
                })
                .catch((error) => {
                    console.error('Login Failed', error);
                });
        }

        function logout() {
            auth.signOut().then(() => {
                // Sign-out successful.
                document.getElementById('chat').style.display = 'none';
                document.getElementById('auth-container').style.display = 'block';
            }).catch((error) => {
                // An error happened.
                console.error('Logout Failed', error);
            });
        }
        
        document.getElementById('register-button').addEventListener('click', register);
        document.getElementById('login-button').addEventListener('click', login);
        document.getElementById('logout-button').addEventListener('click', logout);

        auth.onAuthStateChanged((user) => {
            if (user) {
                // User is signed in, show chat
                document.getElementById('chat').style.display = 'block';
                document.getElementById('auth-container').style.display = 'none';
            } else {
                // No user is signed in, show auth
                document.getElementById('chat').style.display = 'none';
                document.getElementById('auth-container').style.display = 'block';
            }
    });
</script>
<script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.29.11.min.js"></script>
<script>
    // Function to generate a UUID
    function generateUUID() {
        return crypto.randomUUID();
    }

    // Get or generate a UUID
    let uuid = localStorage.getItem('uuid');
    if (!uuid) {
        uuid = generateUUID();
        localStorage.setItem('uuid', uuid);
    }

    // Initialize PubNub
    const pubnub = new PubNub({
        publishKey: 'pub-c-f4cfb28e-9609-4f31-a449-85b846670476',
        subscribeKey: 'sub-c-d598940a-f949-4733-b0c9-9ceb2f41ce1a',
        uuid: uuid
    });

    // Subscribe to the chat channel
    pubnub.subscribe({
        channels: ['chat_channel'],
        withPresence: true
    });

    // Listen for messages on the chat channel
    pubnub.addListener({
        message: function(event) {
            displayMessage(event.message.text, event.publisher);
        }
    });

    // Function to publish messages
    function publishMessage() {
        const messageBox = document.getElementById('messageBox');
        const messageContent = messageBox.value.trim();

        if (messageContent) {
            pubnub.publish({
                channel: 'chat_channel',
                message: { text: messageContent },
                function(status, response) {
                    if (status.error) {
                        // Handle error here
                        console.log(status);
                    } else {
                        console.log("Message Published w/ timetoken", response.timetoken);
                    }
                }
            });
            messageBox.value = '';
        }
    }

    // Function to display messages
    function displayMessage(message, senderUuid) {
        const messagesDiv = document.getElementById('messages');
        const messageElem = document.createElement('div');
        messageElem.classList.add('message');
        messageElem.textContent = (senderUuid === uuid ? 'You: ' : `User ${senderUuid.substring(0, 8)}: `) + message;
        messagesDiv.appendChild(messageElem);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
</script>
</body>
</html>
